[#_empdept_tutorial]
= EmpDept Tutorial
:docinfo: shared-head
:toc: left
:imagesdir: ../images
:basedir: ..
:dir-source: ../../../../../demos/empdept/src/main/java
:dir-test-source: ../../../../../demos/empdept/src/test/java
:dir-source-sql: ../../../../../demos/empdept/src/main/sql
:url-javadoc: link:../api

== Screenshots

.Departments
[%collapsible]
====
image::tutorials/empdept/departments.png[]
====

== Database

.Create Schema SQL
[%collapsible]
====
[source,sql]
----
include::{dir-source-sql}/create_schema.sql[]
----
====

== Domain

We start by creating a class named EmpDept in a package of our choosing, extending DefaultDomain and define the identity and attribute constants required for the department {url-javadoc}{framework-domain}/is/codion/framework/domain/entity/Entity.html[Entity], which is based on the SCOTT.DEPT table. The EntityType constant represents the entity type, the attributes represent the columns in the table. The entityType in this example contains the actual table name (scott.dept), but the table name can be specified via the __tableName()__ builder method when the entity is defined. The attribute names are the actual column names from the table, but these can also be specified via __columnName()__ builder method.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tags=departmentConstants]
----

Next we define the constants required for the employee entity, which is based on the SCOTT.EMP table. Here there are two additional attributes with _FK suffixes, we'll use these later when we specify the foreign key properties for the employee entity.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tags=employeeConstants]
----

In this section we add a constructor, calling the two methods adding the entity definitions to the domain model.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tags=constructor]
----

Next we add the method defining the department entity. *EntityDefinition.Builder* instances are provided by the {url-javadoc}{framework-domain}/is/codion/framework/domain/entity/EntityDefinition.html[EntityDefinition] class, via the *definition* method, which takes an array of *Property.Builder* instances as parameter. For an overview of the *Property* class see <<{basedir}/manual/manual.adoc#_property, Manual#Property>>. The *EntityDefinition.Builder* class provides chained setters for configuring the entity, such as the primary key value source. Here we set the default order by, the so-called *stringFactory* which is responsible for providing *toString()* implementations for entities, the *smallDataset* attribute which hints that it is OK to automatically base ComboBoxes on the entity, and we also set the *caption*. In this case we simply have the department string provider return the department name.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tags=defineDepartment]
----

Next we define the employee entity. Here we set the *keyGenerator* to *KeyGenerator.increment("scott.emp", Employee.ID.name())* which, as the name suggests, simply increments the maximum column value by one (__N.B. this is a very simplistic implementation which is absolutely not transaction safe__). Here we also introduce the <<{basedir}/manual/manual.adoc#_foreignkeyproperty, ForeignKeyProperty>>, the *orderBy*, as well as a *ColorProvider* which is responsible for providing a custom color for an entity instance.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tags=defineEmployee]
----

=== Domain unit test

To unit test the domain model we extend {url-javadoc}{framework-domain-test}/is/codion/framework/domain/entity/test/EntityTestUnit.html[EntityTestUnit] and create a public test method for each entity we want tested and within that method call *test(entityType)*. The *EntityTestUnit* relies on information from the domain model to construct random entity instances and run insert, update, select and delete tests. The tests are run within their own transactions which are then rolled back. We can provide our own entity instances if we'd like by overriding *initializeTestEntity(entityType, foreignKeyEntities)* handling the cases we'd like and delegating the rest to the superclass implementation. The same can be done for entities that are referenced via foreign keys and are required in order to be able to insert records.

NOTE: The {url-javadoc}{framework-domain-test}/is/codion/framework/domain/entity/test/EntityTestUnit.html#TEST_USER[EntityTestUnit.TEST_USER] configuration value specifies the user credentials to use when running the tests, you can set it directly or via the *codion.test.user* system property.

[source,java]
----
include::{dir-test-source}/is/codion/framework/demos/empdept/domain/EmpDeptTest.java[tags=domainTest]
----

Here is the parameter required for running the EmpDept test on the default H2 embedded database, assuming the database resides in the working directory.

-Dcodion.db.url=jdbc:h2:mem:h2db
-Dcodion.test.user=scott:tiger

For further information on parameters required for running Codion applications see <<{basedir}/technical/client.adoc#_client_configuration, client configuration>> and <<{basedir}/technical/server.adoc#_server_configuration, server configuration>>.

== Model

In many cases we can use the default model implementations, but here we will customize the employee edit model by extending {url-javadoc}{swing-framework-model}/is/codion/swing/framework/model/SwingEntityEditModel.html[SwingEntityEditModel].

We must provide a constructor with a single *EntityConnectionProvider* parameter. We also call the *bindEvents* method we define later on.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/model/EmployeeEditModel.java[tags=constructor]
----

At some point we are going to be editing the manager property of an employee which means we'll need a value list of managers. We override *createForeignKeyComboBoxModel* in order to provide a specialized combo box model for the manager property.

NOTE: The foreign key attribute (EmpDept.EMPLOYEE_MGR_FK) is used when referring to the manager property, very rarely do we have to worry about the underlying reference attribute (EmpDept.EMPLOYEE_MGR).

We start by calling the super class method which creates an unfiltered {url-javadoc}{framework-model}/is/codion/framework/model/EntityComboBoxModel.html[EntityComboBoxModel], then we configure the one for the manager foreign key so that it only displays employees with the job PRESIDENT or MANAGER.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/model/EmployeeEditModel.java[tags=createForeignKeyComboBox]
----

Finally, we bind a couple of events, for further information see <<{basedir}/manual/manual.adoc#_event_binding, Manual#Event binding>>.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/model/EmployeeEditModel.java[tags=bindEvents]
----

== UI

If we want to do any editing we must provide a *EntityEditPanel* implementation for the entity, we start by creating a *DepartmentEditPanel*.

A class extending *EntityEditPanel* must provide a constructor taking a single *SwingEntityEditModel* parameter.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentEditPanel.java[tags=constructor]
----

We override the *intializeUI* method to construct the actual UI, used for editing the department entity. The {url-javadoc}{swing-framework-ui}/is/codion/swing/framework/ui/EntityEditPanel.html[EntityEditPanel] class provides methods for creating all the basic controls required, named *create...*, such as *createTextField(attribute)* or *createForeignKeyComboBox(foreignKey)*.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentEditPanel.java[tags=initializeUI]
----

We extend *EntityTablePanel* for the department entity in order to provide a report print action.

A class extending *EntityTablePanel* must provide a constructor taking a single *SwingEntityTableModel* parameter.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentTablePanel.java[tags=constructor]
----

We create a method for viewing a report, which is called via an action we'll initialize in the next step. For further information about report viewing and printing see <<{basedir}/manual/manual.adoc#_reporting_with_jasperreports, Manual#Reporting with JasperReports>>.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentTablePanel.java[tags=viewEmployeeReport]
----

Next we override *createPrintControls()* to add our report action to the popup print control set.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentTablePanel.java[tags=createPrintControls]
----

For editing employee entities we create the *EmployeeEditPanel* class.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmployeeEditPanel.java[tags=constructor]
----

All we have to do is override *initializeUI*.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmployeeEditPanel.java[tags=initializeUI]
----

[#_main_application_panel]
=== Main application panel

We create a main application panel by extending {url-javadoc}{swing-framework-ui}/is/codion/swing/framework/ui/EntityApplicationPanel.html[EntityApplicationPanel]. Overriding *createEntityPanels()* we create two *EntityPanels* using the *SwingEntityModels* from the application model and return the department panel, which will act as the root panel.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=createEntityPanels]
----

Next we add a method for importing a JSON text file, which we'll call via an action initialized in the next section.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=importJSON]
----

We override *createToolsMenuControls()* to add our import action to the Tools menu.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=createToolsMenuControls]
----

We implement *createApplicationModel()* by returning an instance of the *EmpDeptApplicationModel* class, which we'll define later.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=createApplicationModel]
----

We create a *main()* method for configuring and running the application. See <<{basedir}/technical/client.adoc#_client_configuration, client configuration>> for what configuration is required for running the client.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=main]
----

We then define the *EmpDeptApplicationModel* class by extending *SwingEntityApplicationModel*.

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tags=applicationModel]
----

[#_load_test]
== Load test

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/EmpDeptLoadTest.java[tags=loadTest]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/scenarios/InsertDepartment.java[tags=loadTest]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/scenarios/InsertEmployee.java[tags=loadTest]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/scenarios/LoginLogout.java[tags=loadTest]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/scenarios/SelectDepartment.java[tags=loadTest]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/testing/scenarios/UpdateEmployee.java[tags=loadTest]
----

== Full Demo Source

=== Domain

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/domain/EmpDept.java[tag=**]
----

=== Domain unit test

[source,java]
----
include::{dir-test-source}/is/codion/framework/demos/empdept/domain/EmpDeptTest.java[tag=**]
----

=== Model

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/model/EmployeeEditModel.java[tag=**]
----

=== UI

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentEditPanel.java[tag=**]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/DepartmentTablePanel.java[tag=**]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmployeeEditPanel.java[tag=**]
----

[source,java]
----
include::{dir-source}/is/codion/framework/demos/empdept/ui/EmpDeptAppPanel.java[tag=**]
----