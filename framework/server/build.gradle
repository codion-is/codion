apply plugin: 'application'

configurations {
    serverRuntime
}

dependencies {
    compile project(':org.jminor.common.core')
    compile project(':org.jminor.common.db')
    compile project(':org.jminor.common.server')

    compile project(':org.jminor.framework.db.core')
    compile project(':org.jminor.framework.db.local')
    compile project(':org.jminor.framework.db.remote')

    testRuntime "com.h2database:h2:${h2Version}"

    serverRuntime project(':org.jminor.common.core')
    serverRuntime project(':org.jminor.common.db')
    serverRuntime project(':org.jminor.common.server')
    serverRuntime project(':org.jminor.common.server.http')
    serverRuntime project(':org.jminor.framework.db.core')
    serverRuntime project(':org.jminor.framework.db.local')
    serverRuntime project(':org.jminor.framework.db.remote')
    serverRuntime project(':org.jminor.framework.server')
    serverRuntime project(':org.jminor.framework.servlet')
    serverRuntime project(':org.jminor.plugin.jasperreports')
    serverRuntime project(':org.jminor.plugin.hikari.pool')
    serverRuntime project(':org.jminor.plugin.logback.proxy')

    serverRuntime files("../../demos/empdept/build/libs/org.jminor.framework.demos.empdept-domain-${version}.jar")
    serverRuntime files("../../demos/chinook/build/libs/org.jminor.framework.demos.chinook-domain-${version}.jar")
    serverRuntime files("../../demos/petstore/build/libs/org.jminor.framework.demos.petstore-domain-${version}.jar")
    serverRuntime files("../../demos/schemabrowser/build/libs/org.jminor.framework.demos.schemabrowser-domain-${version}.jar")
    serverRuntime files("../../demos/world/build/libs/org.jminor.framework.demos.world-domain-${version}.jar")

    serverRuntime "com.h2database:h2:${h2Version}"
}

mainClassName = 'org.jminor.framework.server.DefaultEntityConnectionServer'

applicationDistribution.from(files(
        '../../resources/security/JMinorServerKeystore',
        '../../resources/security/JMinorServerMonitorTruststore',
        '../../resources/security/jminor_server.policy',
        '../../resources/security/all_permissions.policy',
        '../../resources/security/notsoserial-whitelist.txt')) {
    into("config")
}

applicationDistribution.from(fileTree(dir: '../../resources/server/config', include: '**/*')) {
    into("config")
}

applicationDefaultJvmArgs = [
        "-Djava.security.policy=../config/all_permissions.policy",
        "-Djminor.configurationFile=../config/h2_embedded.config"
]

task runServer(type: JavaExec) {
    group = 'run'
    classpath = configurations.serverRuntime
    main = 'org.jminor.framework.server.DefaultEntityConnectionServer'
//    jvmArgs '--add-modules', 'java.xml.bind'
    systemProperties = [
            'jminor.db.type': 'h2',
            'jminor.db.host': 'h2db',
            'jminor.db.embedded': 'true',
            'jminor.db.embeddedInMemory': 'true',
            'jminor.db.initScript': '../../demos/empdept/src/main/sql/create_schema.sql,../../demos/chinook/src/main/sql/create_schema.sql,../../demos/petstore/src/main/sql/create_schema.sql,../../demos/world/src/main/sql/create_schema.sql',
            'jminor.server.pooling.startupPoolUsers': 'scott:tiger',
            'jminor.server.port': '2222',
            'jminor.server.admin.port': '2223',
            'jminor.server.admin.user': 'scott:tiger',
            'jminor.server.pooling.poolProviderClass': 'org.jminor.framework.plugins.hikari.pool.HikariConnectionPoolProvider',
            'jminor.server.auxiliaryServerClassNames': 'org.jminor.framework.servlet.EntityServletServer',
            'jminor.server.domain.classes': 'org.jminor.framework.demos.empdept.domain.EmpDept,org.jminor.framework.demos.chinook.domain.Chinook,org.jminor.framework.demos.petstore.domain.Petstore,org.jminor.framework.demos.schemabrowser.domain.SchemaBrowser,org.jminor.framework.demos.world.domain.World',
            'javax.net.ssl.keyStore': '../../resources/security/JMinorServerKeystore',
            'java.security.policy': '../../resources/security/all_permissions.policy',
            'javax.net.ssl.keyStorePassword': 'crappypass',
            'java.rmi.server.hostname': 'localhost',
            'logback.configurationFile': '../../resources/server/config/logback.xml'
    ]
}