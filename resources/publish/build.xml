<project name="jminor-publish" xmlns:ivy="antlib:org.apache.ivy.ant">

  <property file="../../../build.properties"/>
  <property file="../../../user.properties"/>

  <property name="ivy.pom.version" value="${version}"/>

  <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpath="${ivy.jar}"/>

  <target name="copy-artifacts">
    <copy todir="common-model">
      <fileset dir="../../dist" includes="jminor-common-model*.jar"/>
    </copy>
    <copy todir="common-ui">
      <fileset dir="../../dist" includes="jminor-common-ui*.jar"/>
    </copy>
    <copy todir="db-core">
      <fileset dir="../../dist" includes="jminor-db-core*.jar"/>
    </copy>
    <copy todir="db-local">
      <fileset dir="../../dist" includes="jminor-db-local*.jar"/>
    </copy>
    <copy todir="db-remote">
      <fileset dir="../../dist" includes="jminor-db-remote*.jar"/>
    </copy>
    <copy file="../../dist/jminor-client.jar" todir="client"/>
    <copy file="../../dist/jminor-client-src.jar" todir="client"/>
    <copy file="../../dist/jminor-client-api-doc.jar" todir="client"/>
    <copy file="../../dist/jminor-client-bundle.jar" todir="client-bundle"/>
    <copy file="../../dist/jminor-client-bundle-src.jar" todir="client-bundle"/>
    <copy file="../../dist/jminor-client-bundle-api-doc.jar" todir="client-bundle"/>
    <copy file="../../dist/jminor-server.jar" todir="server"/>
    <copy file="../../dist/jminor-server-src.jar" todir="server"/>
    <copy file="../../dist/jminor-server-api-doc.jar" todir="server"/>
    <copy todir="plugin-jasperreports">
      <fileset dir="../../dist" includes="jminor-plugin-jasperreports*.jar"/>
    </copy>
    <copy todir="plugin-json">
      <fileset dir="../../dist" includes="jminor-plugin-json*.jar"/>
    </copy>
    <copy todir="plugin-rest">
      <fileset dir="../../dist" includes="jminor-plugin-rest*.jar"/>
    </copy>
    <copy todir="plugin-tomcat-pool">
      <fileset dir="../../dist" includes="jminor-plugin-tomcat-pool*.jar"/>
    </copy>
  </target>

  <target name="publish-all" depends="copy-artifacts" description="publish all module artifacts">
    <subant target="publish" buildpath="common-model" />
    <subant target="publish" buildpath="common-ui" />
    <subant target="publish" buildpath="db-core" />
    <subant target="publish" buildpath="db-local" />
    <subant target="publish" buildpath="db-remote" />
    <subant target="publish" buildpath="client" />
    <subant target="publish" buildpath="server" />
    <subant target="publish" buildpath="client-bundle" />
    <subant target="publish" buildpath="plugin-jasperreports" />
    <subant target="publish" buildpath="plugin-json" />
    <subant target="publish" buildpath="plugin-rest" />
    <subant target="publish" buildpath="plugin-tomcat-pool" />
  </target>

  <target name="resolve_all" description="Resolves all module dependencies">
    <subant target="resolve" buildpath="common-model" />
    <subant target="resolve" buildpath="common-ui" />
    <subant target="resolve" buildpath="db-core" />
    <subant target="resolve" buildpath="db-local" />
    <subant target="resolve" buildpath="db-remote" />
    <subant target="resolve" buildpath="client" />
    <subant target="resolve" buildpath="client-bundle" />
    <subant target="resolve" buildpath="server" />
    <subant target="resolve" buildpath="plugin-jasperreports" />
    <subant target="resolve" buildpath="plugin-json" />
    <subant target="resolve" buildpath="plugin-rest" />
    <subant target="resolve" buildpath="plugin-tomcat-pool" />
  </target>

  <target name="create-pom">
    <ivy:resolve/>
    <ivy:deliver deliverpattern="ivy.xml" pubrevision="${version}"/>
    <ivy:makepom ivyfile="ivy.xml" pomfile="${ant.project.name}.pom">
      <mapping conf="default" scope="compile" />
      <mapping conf="sources" scope="sources" />
      <mapping conf="javadoc" scope="javadoc" />
    </ivy:makepom>
  </target>

  <target name="publish" depends="create-pom" description="Publish the dist files into a local repository">
    <fail unless="version">Version information not set</fail>
    <ivy:resolve/>
    <ivy:publish pubrevision="${version}" status="release" resolver="publish" overwrite="true" forcedeliver="true">
      <artifacts pattern="[artifact].[ext]"/>
    </ivy:publish>
  </target>

  <target name="resolve" description="Resolves all libraries according to ivy.xml">
    <ivy:retrieve pattern="lib/[artifact]-[revision].[ext]" sync="true" type="jar"/>
  </target>
</project>