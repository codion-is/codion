<project name="demo">

  <property name="project.root" value="../.."/>
  <property name="junit.db.initScript" value="src/main/sql/create_schema.sql"/>
  <import file="../build-common.xml"/>

  <available property="reports.available" file="src/main/reports"/>

  <target name="package" depends="common.package" description="Packages this demo application into the ${package} folder">
    <jar jarfile="${package}/${ant.project.name}-domain.jar" basedir="build/main"
         includes="org/jminor/framework/demos/${ant.project.name}/domain/**/*,
         org/jminor/framework/demos/${ant.project.name}/server/**/*"
         manifest="${build.main}/META-INF/MANIFEST.MF"/>
    <!--Create anothor domain jar file without annotations using the purgeannotationrefs library-->
    <!--<taskdef resource="org/dyndns/fichtner/purgeannotationrefs/tasks/antlib.xml" classpathref="lib.ant.util"/>-->
    <!--<purgeannotationrefs>-->
    <!--<src>-->
    <!--<fileset dir="${build.main}">-->
    <!--<filename name="org/jminor/framework/demos/${ant.project.name}/domain/**/*.class" />-->
    <!--</fileset>-->
    <!--</src>-->
    <!--<remove regexp="org.jminor.framework.domain.Entity.Table" />-->
    <!--<remove regexp="org.jminor.framework.domain.Property.Column" />-->
    <!--</purgeannotationrefs>-->
    <!--<jar jarfile="${package}/${ant.project.name}-domain-remote.jar" basedir="${build.main}"-->
    <!--includes="org/jminor/framework/demos/${ant.project.name}/domain/**/*"-->
    <!--manifest="${build.main}/META-INF/MANIFEST.MF"/>-->
  </target>

  <target name="build" depends="common.build, build_reports" description="Builds this demo application">
    <copy todir="${build.main}" failonerror="false">
      <fileset dir="src/main/resources"/>
    </copy>
  </target>

  <target name="build_reports" depends="common.build" if="reports.available" description="Builds the demo reports, if any">
    <taskdef name="jrc" classname="net.sf.jasperreports.ant.JRAntCompileTask">
      <classpath refid="lib.test"/>
    </taskdef>
    <mkdir dir="build/reports"/>
    <jrc srcdir="src/main/reports" includes="**/*.jrxml" destdir="build/reports"/>
  </target>

  <target name="run_local" depends="build"
          description="Runs the demo application with a local db connection">
    <java classname="${client.main.class}" fork="yes">
      <classpath>
        <pathelement path="${build.main}"/>
        <path refid="lib.runtime"/>
      </classpath>
      <jvmarg value="-Djminor.db.type=${demo.db.type}"/>
      <jvmarg value="-Djminor.db.host=${demo.db.host}"/>
      <jvmarg value="-Djminor.db.port=${demo.db.port}"/>
      <jvmarg value="-Djminor.db.sid=${demo.db.sid}"/>
      <jvmarg value="-Djminor.db.embedded=${demo.db.embedded}"/>
      <jvmarg value="-Djminor.db.embeddedInMemory=${demo.db.embeddedInMemory}"/>
      <jvmarg value="-Djminor.db.initScript=${demo.db.initScript}"/>
      <jvmarg value="-Djminor.report.path=build/reports"/>
    </java>
  </target>

  <target name="run_remote" depends="build"
          description="Runs the demo application with a remote db connection">
    <java classname="${client.main.class}" fork="yes">
      <classpath>
        <pathelement path="${build.main}"/>
        <path refid="lib.runtime"/>
      </classpath>
      <jvmarg value="-Djminor.client.connectionType=remote"/>
      <jvmarg value="-Djminor.server.hostname=localhost"/>
      <!--this report path setting is based on the fact that the server is run in the demos directory-->
      <jvmarg value="-Djminor.report.path=chinook/build/reports"/>
      <jvmarg value="-Djavax.net.ssl.trustStore=../../resources/security/JMinorClientTruststore"/>
      <jvmarg value="-Djava.security.policy=../../resources/security/jminor_client.policy"/>
    </java>
  </target>

  <target name="run_load_test" depends="build"
          description="Runs the load testing application with a remote db connection">
    <java classname="${loadtest.main.class}" fork="yes">
      <classpath>
        <pathelement path="${build.main}"/>
        <path refid="lib.runtime"/>
      </classpath>
      <jvmarg value="-Djminor.client.connectionType=remote"/>
      <jvmarg value="-Djminor.server.hostname=localhost"/>
      <!--this report path setting is based on the assumption that the servers working directory is the demos directory-->
      <jvmarg value="-Djminor.report.path=chinook/build/reports"/>
      <jvmarg value="-Djavax.net.ssl.trustStore=../../resources/security/JMinorClientTruststore"/>
      <jvmarg value="-Djava.security.policy=../../resources/security/jminor_load_test.policy"/>
    </java>
  </target>

  <target name="deploy" depends="package" description="Deploys this demo application into ${package}/deployment">
    <taskdef name="getdown_digest" classname="com.threerings.getdown.tools.DigesterTask" classpathref="lib.ant.util"/>
    <delete dir="${package}/deployment"/>
    <!--create uber-jar-->
    <mkdir dir="${package}/deployment/libtmp"/>
    <unzip dest="${package}/deployment/libtmp">
      <fileset dir="lib/runtime">
        <include name="**/*.jar"/>
      </fileset>
    </unzip>
    <zip destfile="${package}/deployment/${ant.project.name}.jar">
      <zipfileset src="${package}/${ant.project.name}.jar" excludes="**/META-INF/**/*"/>
      <zipfileset dir="${package}/deployment/libtmp" excludes="**/META-INF/**/*"/>
      <zipfileset file="../../resources/security/JMinorClientTruststore"/>
    </zip>
    <delete dir="${package}/deployment/libtmp"/>

    <!--create web deployment, webstart and getdown-->
    <mkdir dir="${package}/deployment/web"/>
    <copy file="${package}/deployment/${ant.project.name}.jar" todir="${package}/deployment/web"/>
    <zip destfile="${package}/deployment/web/${ant.project.name}.jar" update="true">
      <zipfileset dir="src/main/config/" includes="${ant.project.name}.jnlp" fullpath="JNLP-INF/APPLICATION.JNLP"/>
    </zip>
    <signjar jar="${package}/deployment/web/${ant.project.name}.jar" alias="${jar.sign.alias}"
             storepass="${jar.sign.storepass}" keystore="${jar.sign.keystore}" tsaurl="${deploy.tsaurl}"/>
    <copy file="src/main/config/${ant.project.name}.jnlp" todir="${package}/deployment/web" failonerror="false"/>
    <copy file="src/main/config/getdown.txt" todir="${package}/deployment/web"/>
    <copy file="../../docs/jminor.org/jminor_logo_2.png" tofile="${package}/deployment/web/jminor.png"/>
    <copy file="../../docs/jminor.org/jminor_logo_medium.png" tofile="${package}/deployment/web/jminor-getdown.png"/>

    <!--getdown-->
    <getdown_digest appdir="${package}/deployment/web"/>
    <copy todir="${package}/deployment/web/getdown.tmp/${ant.project.name}" file="../../.lib/ant/getdown-${getdown.version}.jar"/>
    <concat destfile="${package}/deployment/web/getdown.tmp/${ant.project.name}/getdown.txt">appbase = http://jminor.no-ip.org/demos/${ant.project.name}/</concat>
    <concat destfile="${package}/deployment/web/getdown.tmp/${ant.project.name}.sh">java -jar ${ant.project.name}/getdown-${getdown.version}.jar ${ant.project.name}</concat>
    <copy file="${package}/deployment/web/getdown.tmp/${ant.project.name}.sh" tofile="${package}/deployment/web/getdown.tmp/${ant.project.name}.bat"/>
    <zip destfile="${package}/deployment/web/${ant.project.name}-getdown.zip" basedir="${package}/deployment/web/getdown.tmp"/>
    <delete dir="${package}/deployment/web/getdown.tmp"/>

    <!--create local deployment-->
    <mkdir dir="${package}/deployment/local"/>
    <copy todir="${package}/deployment/local">
      <file file="${package}/deployment/${ant.project.name}.jar"/>
      <fileset dir="src/main/config" includes="**/*.sh, **/*.bat"/>
    </copy>
    <chmod dir="${package}/deployment/local" perm="u+x" type="file" includes="**/*.sh"/>
    <copy todir="${package}/deployment/local/config">
      <fileset dir="src/main/config" includes="**/*.config"/>
    </copy>
    <zip destfile="${package}/deployment/local/${ant.project.name}.jar" update="true">
      <zipfileset dir="build/reports" includes="**/*.jasper" prefix="reports" erroronmissingdir="false"/>
      <zipfileset file="src/main/sql/create_schema.sql" erroronmissingdir="false"/>
    </zip>
    <zip destfile="${package}/deployment/web/${ant.project.name}-local.zip">
      <zipfileset dir="${package}/deployment/local"/>
    </zip>
    <delete file="${package}/deployment/${ant.project.name}.jar"/>
  </target>
</project>