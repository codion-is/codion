<project name="jminor-demo" default="build" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant" xmlns:jacoco="antlib:org.jacoco.ant">

  <property name="project.root" value="../../"/>
  <property name="junit.db.initScript" value="src/main/sql/create_schema.sql"/>
  <property file="${project.root}/core/build.properties"/>
  <property file="${project.root}/core/user.properties"/>
  <import file="../build-common.xml"/>

  <target name="dist" depends="jminor-common.dist">
    <jar jarfile="dist/${ant.project.name}-domain.jar" basedir="build/main"
         includes="org/jminor/framework/demos/${ant.project.name}/domain/**/*, org/jminor/framework/demos/${ant.project.name}/server/**/*"
         manifest="${build.main}/META-INF/MANIFEST.MF"/>

    <!--create anothor domain jar file without annotations using the purgeannotationrefs library-->
    <!--<taskdef resource="org/dyndns/fichtner/purgeannotationrefs/tasks/antlib.xml"-->
    <!--classpathref="lib.ant.util"/>-->
    <!--<purgeannotationrefs>-->
    <!--<src>-->
    <!--<fileset dir="build/main">-->
    <!--<filename name="org/jminor/framework/demos/${ant.project.name}/domain/**/*.class" />-->
    <!--</fileset>-->
    <!--</src>-->
    <!--<remove regexp="org.jminor.framework.domain.Entity.Data" />-->
    <!--<remove regexp="org.jminor.framework.domain.Property.Data" />-->
    <!--</purgeannotationrefs>-->
    <!--<jar jarfile="dist/${ant.project.name}-domain-remote.jar" basedir="build/main"-->
    <!--includes="org/jminor/framework/demos/${ant.project.name}/domain/**/*"-->
    <!--manifest="${build.main}/META-INF/MANIFEST.MF"/>-->
  </target>

  <target name="deploy" depends="dist">
    <taskdef name="getdown_digest" classname="com.threerings.getdown.tools.DigesterTask" classpathref="lib.ant.util"/>
    <!--create uber-jar-->
    <mkdir dir="dist/deployment/libtmp"/>
    <unzip dest="dist/deployment/libtmp">
      <fileset dir="lib/runtime">
        <include name="**/*.jar"/>
      </fileset>
    </unzip>
    <zip destfile="dist/deployment/${ant.project.name}.jar">
      <zipfileset src="dist/${ant.project.name}.jar" excludes="**/META-INF/**/*"/>
      <zipfileset dir="dist/deployment/libtmp" excludes="**/META-INF/**/*"/>
      <fileset file="../../core/resources/security/JMinorClientTruststore"/>
    </zip>
    <delete dir="dist/deployment/libtmp"/>

    <!--create web deployment-->
    <copy file="dist/deployment/${ant.project.name}.jar" todir="dist/deployment/web"/>
    <zip destfile="dist/deployment/web/${ant.project.name}.jar" update="true">
      <zipfileset dir="src/main/config/" includes="${ant.project.name}.jnlp" fullpath="JNLP-INF/APPLICATION.JNLP"/>
    </zip>
    <signjar jar="dist/deployment/web/${ant.project.name}.jar" alias="${jar.sign.alias}"
             storepass="${jar.sign.storepass}" keystore="${jar.sign.keystore}"/>
    <copy file="src/main/config/${ant.project.name}.jnlp" todir="dist/deployment/web" failonerror="false"/>
    <copy file="src/main/config/getdown.txt" todir="dist/deployment/web"/>
    <copy file="../../core/docs/jminor.org/jminor_logo_2.png" tofile="dist/deployment/web/jminor.png"/>
    <getdown_digest appdir="dist/deployment/web"/>

    <!--create local deployment-->
    <copy todir="dist/deployment/local">
      <file file="dist/deployment/${ant.project.name}.jar"/>
      <fileset dir="src/main/config" includes="**/*.sh, **/*.bat"/>
    </copy>
    <zip destfile="dist/deployment/local/${ant.project.name}.jar" update="true">
      <zipfileset dir="build/reports" includes="**/*.jasper" prefix="reports" erroronmissingdir="false"/>
      <zipfileset file="src/main/sql/create_schema.sql" erroronmissingdir="false"/>
      <zipfileset file="src/main/config/logback.xml"/>
      <zipfileset dir="src/main/config" includes="**/*.config"/>
    </zip>
    <chmod dir="dist/deployment/local" perm="u+x" type="file" includes="**/*.sh"/>
    <zip destfile="dist/deployment/web/${ant.project.name}.zip">
      <zipfileset dir="dist/deployment/local"/>
    </zip>
    <delete file="dist/deployment/${ant.project.name}.jar"/>
  </target>
</project>